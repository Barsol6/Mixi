@page "/pdf/upload"

@inject HttpClient Http
@inject PdfPopup PdfPopup
@inject NavigationManager NavigationManager


@using System.Net.Http.Headers
@using Mixi.Shared.Models.UI
@implements IDisposable

<div class="pdfChoicePanel">
    <h3>Send Character Sheet</h3>
    <div class="login-box items-center">
        <div class="login">
            <div class="data-box">
                <InputFile OnChange="@(e => HandleFileSelected(e))" accept=".pdf"/>
            </div>
            <div class="data-box">
                <input @bind="_fileName" type="text" required/>
                <span>PDF Name</span>
            </div>
            @if (_isUploading)
            {
                <p>Uploading...</p>
            }
            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <p>@_errorMessage</p>
            }
            <div class="data-box">
                <div class="logButton" @onclick="@(async () =>
                                                 {
                                                     if (_fileSelected && !_isUploading && _fileName != string.Empty) await UploadFile();
                                                 })"
                     style="@(_fileSelected && !_isUploading ? "" : "opacity: 0.5; cursor: not-allowed;")">
                    <span class="logButton-content">SEND</span>
                </div>
            </div>
            <div class="data-box">
                <div class="logButton">
                    <div class="closeButton-content " @onclick="() => ClosePopup()">
                        CLOSE
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {

    private IBrowserFile _selectedFile;
    private bool _fileSelected;
    private bool _isUploading;
    private string _errorMessage = string.Empty;
    private string _fileName = string.Empty;


    protected override void OnInitialized()
    {
        PdfPopup.PdfNameChanged += () => InvokeAsync(StateHasChanged);
        PdfPopup.IsVisibleChange += () => InvokeAsync(StateHasChanged);
        base.OnInitialized();
    }

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        _selectedFile = e.File;
        _fileSelected = true;
        _errorMessage = string.Empty;
        Console.WriteLine($"File selected: {_fileSelected}, ContentType: {_selectedFile.ContentType}");
        if (!_selectedFile.ContentType.Equals("application/pdf", StringComparison.OrdinalIgnoreCase))
        {
            _errorMessage = "File must be PDF";
            _fileSelected = false;
        }

        StateHasChanged();
    }

    private async Task UploadFile()
    {
        if (!_fileSelected || _isUploading || string.IsNullOrEmpty(_fileName))
        {
            return;
        }

        _isUploading = true;
        _errorMessage = string.Empty;

        StateHasChanged();

        try
        {
            using var content = new MultipartFormDataContent();
            using var fileStream = _selectedFile.OpenReadStream(20 * 1024 * 1024);
            using var streamContent = new StreamContent(fileStream);
            streamContent.Headers.ContentType = new MediaTypeHeaderValue(_selectedFile.ContentType);

            content.Add(streamContent, "FormFile", _selectedFile.Name);
            content.Add(new StringContent(_fileName), "FileName");

            var response = await Http.PostAsync("api/Pdf/upload", content);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<UploadResult>();
                PdfPopup.PdfName = result.id;
                ClosePopup();
            }
            else
            {
                _errorMessage = $"Upload failed: {await response.Content.ReadAsStringAsync()}";
            }
        }
        catch (Exception e)
        {
            _errorMessage = $"Uploading error: {e.Message}";
        }
        finally
        {
            _isUploading = false;
            StateHasChanged();
        }
    }

    private class UploadResult
    {
        public string id { get; set; }
    }

    private async void ClosePopup()
    {
        NavigationManager.NavigateTo("/pdf/viewer_choice");
    }

    public void Dispose()
    {
        PdfPopup.IsVisibleChange -= StateHasChanged;
        PdfPopup.PdfNameChanged -= StateHasChanged;
    }

}