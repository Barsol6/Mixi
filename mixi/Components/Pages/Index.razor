@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using mixi.Components.Layout
@using mixi.Modules.UI

@page "/home"
@rendermode InteractiveServer
@layout MainLayout

@inject MenuPopup MenuPopup
@inject SignUpPopup SignUp
@inject ProtectedSessionStorage Storage

@implements IDisposable

<LoginPage @ref="_loginPage"> </LoginPage>
<Menu @ref="_menu"> </Menu>
@code {

    LoginPage _loginPage = new LoginPage();
    Menu _menu = new Menu();
    
    protected override void OnInitialized()
    {
        this.SignUp.IsVisibleChange += () => InvokeAsync(StateHasChanged);
        this.SignUp.IsLoggedChange += () => InvokeAsync(StateHasChanged);
        this.MenuPopup.IsVisibleChange += () => InvokeAsync(StateHasChanged);
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            MenuPopup.IsVisible = false;
            SignUp.IsVisible = false;
            SignUp.IsLogged = false;
            await Storage.SetAsync("MenuIsVisible", false);
            await  Storage.SetAsync("IsLogged", false);
            await Storage.SetAsync("SignUpPopupIsVisible", false);  
            StateHasChanged();
        }
        else
        {
            var popupIsVisible = await  Storage.GetAsync<bool>("MenuIsVisible");
            MenuPopup.IsVisible = popupIsVisible.Value; 
            var isLogged = await  Storage.GetAsync<bool>("IsLogged");
            SignUp.IsLogged = isLogged.Value;
            var signUpPopupIsVisible = await  Storage.GetAsync<bool>("SignUpPopupIsVisible");
            SignUp.IsVisible = signUpPopupIsVisible.Value;
        }
  
    }
    
    public void Dispose()
    {
        this.SignUp.IsVisibleChange -= StateHasChanged;
        this.SignUp.IsLoggedChange -= StateHasChanged;
        this.MenuPopup.IsVisibleChange -= StateHasChanged;
    }
}